name: One Drop

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 * * * *' # hourly loop

env:
  PAYPAL_ACCOUNT: charlesbuchanan89@yahoo.com
  ORACLESIGNAL_WEBHOOK_URL: ${{ secrets.ORACLESIGNAL_WEBHOOK_URL }}
  SHOPIFY_API_KEY: ${{ secrets.SHOPIFY_API_KEY }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 18
      - run: npm install && npm run build
      - run: echo "Deploying to Pages with PayPal: $PAYPAL_ACCOUNT"

  crypto-oracle-loop:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - run: |
          pip install -r requirements.txt
          python crypto_oracle.py analyze BTC/USDT --timeframes 1h 4h 1d
          echo "Broadcasting strategy to OracleSignal"
      - name: Notify OracleSignal
        run: curl -X POST $ORACLESIGNAL_WEBHOOK_URL -d '{"status":"live","payout":"'"$PAYPAL_ACCOUNT"'"}'

  validate-scrolls:
    runs-on: ubuntu-latest
    steps:
      - uses: cardinalby/schema-validator-action@v3
        with:
          file: 'scrolls/*.yml'
          schema: 'schemas/scroll.schema.json'

  seal-scroll:
    runs-on: ubuntu-latest
    steps:
      - run: echo "Sealing scrolls with sovereign logic"
      - run: echo "Routing to $PAYPAL_ACCOUNT"

  sync-metafields:
    runs-on: ubuntu-latest
    steps:
      - run: |
          curl -X POST https://your-shopify-endpoint \
          -H "X-Shopify-Access-Token: $SHOPIFY_API_KEY" \
          -d '{"metafields":[{"key":"tag","value":"BBW","namespace":"custom"}]}'

  intake-flow:
    runs-on: ubuntu-latest
    steps:
      - run: echo "Onboarding contributor with emotional tags and payout: $PAYPAL_ACCOUNT"

  deploy-sitemap:
    runs-on: ubuntu-latest
    steps:
      - run: echo "Deploying sitemap for search indexing"
name: Canary Traffic Ramp-Up Deployment
on:
  push:
    branches:
      - main

jobs:
  phased-deploy:
    name: Canary Ramp-Up Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Install dependencies
        run: npm install

      ###############################################################
      # 1. DEPLOY CANARY BUILD
      ###############################################################
      - name: Deploy Canary Worker
        run: |
          wrangler deploy --env canary --outdir dist-canary
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      ###############################################################
      # Function: Health check loop
      ###############################################################
      - name: Define health check function
        id: health
        shell: bash
        run: |
          echo 'run() {
              URL="https://${{ secrets.WORKER_PROD_URL }}/health"
              ERRORS=0
              LATENCY_TOTAL=0
              for i in {1..10}; do
                START=$(date +%s%3N)
                CODE=$(curl -s -o /dev/null -w "%{http_code}" $URL)
                END=$(date +%s%3N)
                LAT=$(($END - $START))
                LATENCY_TOTAL=$((LATENCY_TOTAL + LAT))
                [[ "$CODE" != "200" ]] && ERRORS=$((ERRORS + 1))
              done
              AVG_LAT=$((LATENCY_TOTAL / 10))
              echo "Errors:$ERRORS Latency:$AVG_LAT"
              if [ "$ERRORS" -gt 2 ] || [ "$AVG_LAT" -gt 350 ]; then
                echo "::set-output name=healthy::no"
              else
                echo "::set-output name=healthy::yes"
              fi
          }' > health_check.sh
          chmod +x health_check.sh

      ###############################################################
      # 2. TRAFFIC RAMP: 5% â†’ 20% â†’ 50% â†’ 100%
      ###############################################################

      - name: Ramp to 5%
        run: |
          wrangler deploy --env production --experimental-canary --canary-percent=5
          ./health_check.sh
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Stop if 5% unhealthy
        if: steps.health.outputs.healthy == 'no'
        run: wrangler deploy --env production --rollback

      - name: Ramp to 20%
        if: steps.health.outputs.healthy == 'yes'
        run: |
          wrangler deploy --env production --experimental-canary --canary-percent=20
          ./health_check.sh

      - name: Stop if 20% unhealthy
        if: steps.health.outputs.healthy == 'no'
        run: wrangler deploy --env production --rollback

      - name: Ramp to 50%
        if: steps.health.outputs.healthy == 'yes'
        run: |
          wrangler deploy --env production --experimental-canary --canary-percent=50
          ./health_check.sh

      - name: Stop if 50% unhealthy
        if: steps.health.outputs.healthy == 'no'
        run: wrangler deploy --env production --rollback

      ###############################################################
      # 3. FULL PROMOTION (100%)
      ###############################################################
      - name: Promote to 100% if healthy
        if: steps.health.outputs.healthy == 'yes'
        run: |
          wrangler deploy --env production
          echo "ðŸš€ Fully promoted to 100% production traffic."
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}WORKER_PROD_URL=your-worker.yourdomain.com.github/workflows/canary-deploy.yml
wrangler deploy wrangler r2 bucket create ORACLE_AUDIT git checkout -b main-production
git checkout -b dev
git checkout -b sandbox
git push -u origin main-production
git push -u origin dev
git push -u origin sandbox<key>NSUserActivityTypes</key>
<array>
    <string>com.example.myapp.create-shape</string>
    <string>com.example.myapp.edit-shape</string>
    <string>com.example.myapp.edit-document-properties</string>
</array>env:
  BRANDING_PDF_URL: ${{ secrets.BRANDING_PDF_URL || 'file:///mnt/data/Build_X_FULL_package.pdf' }}